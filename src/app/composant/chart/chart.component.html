<div class="chart-wrapper">
  <!-- Terminal Header -->
  <div class="terminal-header">
    <span class="prompt">$</span>
    <span class="command">cat /var/log/metrics --source</span>
  </div>

  <!-- État de chargement -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="terminal-loading">
        <span class="status-prefix">[...]</span>
        <span class="status-text">fetching data</span>
        <span class="cursor">_</span>
      </div>
    </div>
  }

  <!-- État d'erreur -->
  @if (error && !isLoading) {
    <div class="error-state">
      <div class="terminal-error">
        <span class="status-prefix">[ERR]</span>
        <span class="status-text">{{ error }}</span>
      </div>
      <button (click)="refreshData()" class="retry-button">
        retry
      </button>
    </div>
  }

  <!-- Contenu principal -->
  @if (!isLoading && !error) {
    <div class="chart-content">
      <!-- Terminal Status OK -->
      <div class="terminal-status">
        <span class="status-prefix ok">[OK]</span>
        <span class="status-text">{{ fullData.length }} languages loaded</span>
      </div>

      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <div class="toggle-header">
          <span class="toggle-label">--mode</span>
        </div>
        <div class="toggle-options">
          <button
            class="mode-btn"
            [class.active]="viewMode === 'source'"
            (click)="setViewMode('source')"
          >
            <span class="mode-icon">◆</span>
            <span class="mode-name">source</span>
          </button>
          <button
            class="mode-btn"
            [class.active]="viewMode === 'history'"
            (click)="setViewMode('history')"
          >
            <span class="mode-icon">◇</span>
            <span class="mode-name">history</span>
          </button>
        </div>
      </div>

      <!-- Source Mode Controls -->
      @if (viewMode === 'source') {
        <!-- Source Selector -->
        <div class="source-selector">
          <div class="selector-header">
            <span class="selector-label">--source</span>
          </div>
          <div class="source-options">
            @for (source of availableSources; track source.id) {
              <button
                class="source-btn"
                [class.active]="source.enabled"
                [style.--source-color]="source.color"
                (click)="toggleSource(source.id)"
              >
                <span class="source-indicator"></span>
                <span class="source-name">{{ source.label }}</span>
              </button>
            }
          </div>
        </div>

        <!-- Source Info -->
        <div class="source-info">
          <span class="info-label"># source details</span>
          <div class="info-items">
            @for (source of availableSources; track source.id) {
              <div class="info-item" [class.disabled]="!source.enabled">
                <span class="info-dot" [style.background]="source.color"></span>
                <span class="info-name">{{ source.label }}:</span>
                <span class="info-desc">{{ source.description }}</span>
              </div>
            }
          </div>
        </div>

        <!-- No source selected warning -->
        @if (getEnabledSources().length === 0) {
          <div class="no-source-warning">
            <span class="warning-prefix">[WARN]</span>
            <span class="warning-text">no source selected</span>
          </div>
        }
      }

      <!-- History Mode Controls -->
      @if (viewMode === 'history') {
        <div class="filter-container">
          <label for="yearSelect">--year</label>
          <select id="yearSelect" [value]="selectedYear" (change)="onYearChange($event)">
            @for (year of years; track year) {
              <option [value]="year">{{ year }}</option>
            }
          </select>
        </div>
      }

      <!-- Graphique -->
      <div class="chart-container">
        <canvas id="languageChart"></canvas>
      </div>

      <!-- Bouton de rafraîchissement -->
      <div class="refresh-button-container">
        <button (click)="refreshData()" class="refresh-button">
          <span class="prompt">$</span> refresh --force
        </button>
      </div>
    </div>
  }
</div>
